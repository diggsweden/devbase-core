#!/usr/bin/env bash
# Pre-push hook dispatcher
# Runs all executable scripts in pre-push.d/

set -e

script_dir="$(cd -- "$(dirname -- "$0")" >/dev/null 2>&1 && pwd -P)"
hooks_dir="$script_dir/pre-push.d"

if [[ ! -d "$hooks_dir" ]]; then
  exit 0
fi

# Check if any executable scripts exist
shopt -s nullglob
scripts=("$hooks_dir"/*.sh)
shopt -u nullglob

if [[ ${#scripts[@]} -eq 0 ]]; then
  exit 0
fi

# Sort scripts to ensure consistent execution order
IFS=$'\n' scripts=($(sort <<<"${scripts[*]}"))
unset IFS

echo "Running pre-push checks..."

# Run all executable scripts in pre-push.d/ (in sorted order)
for script in "${scripts[@]}"; do
  if [[ -x "$script" ]]; then
    "$script" "$@" || {
      echo "✗ Hook failed: $(basename "$script")" >&2
      exit 1
    }
  fi
done

echo "✓ All pre-push checks passed"
exit 0
