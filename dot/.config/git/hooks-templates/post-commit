#!/usr/bin/env bash
# Post-commit hook dispatcher
# Runs all executable scripts in post-commit.d/
# This runs AFTER the commit is completed (cannot block commit)

set -e

script_dir="$(cd -- "$(dirname -- "$0")" >/dev/null 2>&1 && pwd -P)"
hooks_dir="$script_dir/post-commit.d"

if [[ ! -d "$hooks_dir" ]]; then
  exit 0
fi

# Check if any executable scripts exist
shopt -s nullglob
scripts=("$hooks_dir"/*.sh)
shopt -u nullglob

if [[ ${#scripts[@]} -eq 0 ]]; then
  exit 0
fi

# Sort scripts to ensure consistent execution order
IFS=$'\n' scripts=($(sort <<<"${scripts[*]}"))
unset IFS

# Run all executable scripts in post-commit.d/ (in sorted order)
for script in "${scripts[@]}"; do
  if [[ -x "$script" ]]; then
    "$script" || printf "âš  Post-commit hook failed (non-blocking): %s\n" "$(basename "$script")" >&2
  fi
done

exit 0
